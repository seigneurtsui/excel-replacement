<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Batch Replacer</title>
    <style>
        /* ... (ä¿ç•™åŸæœ¬çš„ CSS) ... */
        :root { --primary-color: #007bff; --bg-color: #f4f4f9; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: var(--bg-color); }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .lang-selector { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
        .upload-area { border: 2px dashed #ccc; padding: 30px; text-align: center; margin-bottom: 20px; cursor: pointer; background: white; border-radius: 8px; transition: 0.3s; }
        .upload-area:hover { border-color: var(--primary-color); background: #eef7ff; }
        .file-list { margin-top: 10px; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: white; margin-bottom: 5px; border-radius: 4px; border: 1px solid #eee; }
        .delete-btn { color: #dc3545; cursor: pointer; font-weight: bold; }
        button { padding: 15px; background: var(--primary-color); color: white; border: none; font-size: 16px; border-radius: 5px; cursor: pointer; transition: background 0.2s; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 10px; vertical-align: middle; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #report-section { margin-top: 30px; background: white; padding: 20px; border-radius: 8px; display: none; }
        #report-content { max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border: 1px solid #ddd; font-family: monospace; white-space: pre-wrap; margin-bottom: 15px; }

        /* --- æ–°å¢ï¼šç™»å½•çª—å£ CSS --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 300px; text-align: center;
        }
        .login-box h2 { margin-top: 0; color: #333; }
        .login-box input {
            width: 100%; padding: 12px; margin: 20px 0;
            border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px;
        }
        .login-box button { width: 100%; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 data-i18n="login_title">Login Required</h2>
            <input type="password" id="password-input" placeholder="Enter password">
            <button id="login-btn" data-i18n="login_btn">Login</button>
            <p id="login-error" style="color: red; display: none; margin-top: 10px; font-size: 14px;"></p>
        </div>
    </div>

    <div class="header-bar">
        <h1 data-i18n="title">Excel Batch Replacer</h1>
        <select id="language-select" class="lang-selector">
            <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
            <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
            <option value="en">English</option>
            <option value="fr">FranÃ§ais</option>
            <option value="es">EspaÃ±ol</option>
            <option value="pt">PortuguÃªs</option>
            <option value="it">Italiano</option>
            <option value="de">Deutsch</option>
            <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
            <option value="ja">æ—¥æœ¬èª</option>
        </select>
    </div>

    <p data-i18n="subtitle">Efficiently batch replace text in multiple Excel files.</p>
    <section>
        <h2 data-i18n="target_files">Target Excel Files</h2>
        <div id="target-upload" class="upload-area">
            <span class="icon-large">ğŸ“</span>
            <p data-i18n="drag_drop">Click or drag & drop files here</p>
            <p data-i18n="formats">Supports .xls and .xlsx</p>
        </div>
        <div id="target-files" class="file-list"></div>
    </section>

    <section>
        <h2 data-i18n="replacement_map">Replacement Map</h2>
        <div id="replacement-upload" class="upload-area">
            <span class="icon-large">ğŸ“‹</span>
            <p data-i18n="drag_drop_map">Click or drag & drop the map file</p>
            <p data-i18n="map_format">Format: Col A (key), Col B (value)</p>
        </div>
        <div id="replacement-file" class="file-list"></div>
    </section>

    <section>
        <h2 data-i18n="mode">Match Mode</h2>
        <label>
            <input type="radio" name="match-mode" value="full" checked>
            <span data-i18n="mode_full">Full Match</span>
        </label>
        <br><br>
        <label>
            <input type="radio" name="match-mode" value="partial">
            <span data-i18n="mode_partial">Partial Match</span>
        </label>
    </section>
    
    <br>

    <button id="start-process">
        <span class="spinner"></span>
        <span data-i18n="btn_start">Start Processing</span>
    </button>

    <section id="report-section">
        <h2 data-i18n="report_title">Processing Report</h2>
        <div id="report-content"></div>
        <p data-i18n="download_tip">Processed files downloaded.</p>
    </section>

    <script>
        // --- æ›´æ–°ï¼ši18n å­—å…¸ï¼Œå¢åŠ ç™»å½•ç›¸å…³è¯æ¡ ---
        const translations = {
            'zh-CN': {
                // ...åŸæœ‰...
                title: "Excelæ‰¹é‡å­—ç¬¦æ›¿æ¢å·¥å…·", subtitle: "é«˜æ•ˆæ‰¹é‡å¤„ç†Excelæ–‡æ¡£ä¸­çš„å­—ç¬¦æ›¿æ¢ä»»åŠ¡",
                target_files: "ç›®æ ‡Excelæ–‡æ¡£", drag_drop: "ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ–‡ä»¶", formats: "æ”¯æŒ .xls å’Œ .xlsx",
                replacement_map: "æ›¿æ¢å¯¹ç…§è¡¨", drag_drop_map: "ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å¯¹ç…§è¡¨æ–‡ä»¶", map_format: "æ ¼å¼ï¼šAåˆ— (key)ï¼ŒBåˆ— (value)",
                mode: "åŒ¹é…æ¨¡å¼", mode_full: "å®Œå…¨åŒ¹é… - å•å…ƒæ ¼å†…å®¹å®Œå…¨ç›¸ç­‰", mode_partial: "éƒ¨åˆ†åŒ¹é… - åŒ…å«å…³é”®å­—å³æ›¿æ¢",
                btn_start: "å¼€å§‹æ›¿æ¢", btn_processing: "å¤„ç†ä¸­...",
                report_title: "å¤„ç†æŠ¥å‘Š", download_tip: "å¤„ç†åçš„æ–‡ä»¶å’Œå®Œæ•´æŠ¥å‘Šå·²æ‰“åŒ…ä¸‹è½½ã€‚",
                alert_missing: "è¯·ä¸Šä¼ ç›®æ ‡æ–‡ä»¶å’Œå¯¹ç…§è¡¨", alert_error: "å¤„ç†å¤±è´¥: ",
                // ...æ–°å¢ç™»å½•...
                login_title: "éœ€è¦è®¿é—®å¯†ç ", login_btn: "ç™»å½•", login_err: "å¯†ç é”™è¯¯", login_ph: "è¯·è¾“å…¥å¯†ç "
            },
            'zh-TW': {
                title: "Excelæ‰¹é‡å­—ç¬¦æ›¿æ›å·¥å…·", subtitle: "é«˜æ•ˆæ‰¹é‡è™•ç†Excelæ–‡æª”ä¸­çš„å­—ç¬¦æ›¿æ›ä»»å‹™",
                // ...åŸæœ‰...
                target_files: "ç›®æ¨™Excelæ–‡æª”", drag_drop: "é»æ“Šæˆ–æ‹–æ‹½ä¸Šå‚³æ–‡ä»¶", formats: "æ”¯æŒ .xls å’Œ .xlsx",
                replacement_map: "æ›¿æ›å°ç…§è¡¨", drag_drop_map: "é»æ“Šæˆ–æ‹–æ‹½ä¸Šå‚³å°ç…§è¡¨æ–‡ä»¶", map_format: "æ ¼å¼ï¼šAåˆ— (key)ï¼ŒBåˆ— (value)",
                mode: "åŒ¹é…æ¨¡å¼", mode_full: "å®Œå…¨åŒ¹é… - å–®å…ƒæ ¼å…§å®¹å®Œå…¨ç›¸ç­‰", mode_partial: "éƒ¨åˆ†åŒ¹é… - åŒ…å«é—œéµå­—å³æ›¿æ›",
                btn_start: "é–‹å§‹æ›¿æ›", btn_processing: "è™•ç†ä¸­...",
                report_title: "è™•ç†å ±å‘Š", download_tip: "è™•ç†å¾Œçš„æ–‡ä»¶å’Œå®Œæ•´å ±å‘Šå·²æ‰“åŒ…ä¸‹è¼‰ã€‚",
                alert_missing: "è«‹ä¸Šå‚³ç›®æ¨™æ–‡ä»¶å’Œå°ç…§è¡¨", alert_error: "è™•ç†å¤±æ•—: ",
                // ...æ–°å¢...
                login_title: "éœ€è¦è¨ªå•å¯†ç¢¼", login_btn: "ç™»éŒ„", login_err: "å¯†ç¢¼éŒ¯èª¤", login_ph: "è«‹è¼¸å…¥å¯†ç¢¼"
            },
            'en': {
                title: "Excel Batch Replacer", subtitle: "Efficiently batch replace text in multiple Excel files.",
                // ...åŸæœ‰...
                target_files: "Target Excel Files", drag_drop: "Click or drag & drop files here", formats: "Supports .xls and .xlsx",
                replacement_map: "Replacement Map", drag_drop_map: "Click or drag & drop the map file", map_format: "Format: Col A (key), Col B (value)",
                mode: "Match Mode", mode_full: "Full Match (Exact Cell Content)", mode_partial: "Partial Match (Contains Keyword)",
                btn_start: "Start Processing", btn_processing: "Processing...",
                report_title: "Processing Report", download_tip: "The processed files and full report have been downloaded as a ZIP file.",
                alert_missing: "Please upload target files and replacement map", alert_error: "Error: ",
                // ...æ–°å¢...
                login_title: "Login Required", login_btn: "Login", login_err: "Incorrect password", login_ph: "Enter password"
            },
            // ... (å…¶ä»–è¯­è¨€è¯·æŒ‰ç…§æ­¤æ ¼å¼å¢åŠ  login_title, login_btn, login_err, login_ph) ...
            'fr': { login_title: "Connexion requise", login_btn: "Connexion", login_err: "Mot de passe incorrect", login_ph: "Entrer le mot de passe", title: "Remplacement Excel", subtitle: "...", target_files: "Fichiers Cibles", drag_drop: "Cliquez ici", formats: ".xls .xlsx", replacement_map: "Carte", drag_drop_map: "Cliquez ici", map_format: "Col A/B", mode: "Mode", mode_full: "Exacte", mode_partial: "Partielle", btn_start: "Commencer", btn_processing: "Traitement...", report_title: "Rapport", download_tip: "TÃ©lÃ©chargÃ©.", alert_missing: "Manquant", alert_error: "Erreur: " },
            'es': { login_title: "Inicio de sesiÃ³n", login_btn: "Entrar", login_err: "ContraseÃ±a incorrecta", login_ph: "ContraseÃ±a", title: "Reemplazo Excel", subtitle: "...", target_files: "Archivos", drag_drop: "Clic aquÃ­", formats: ".xls .xlsx", replacement_map: "Mapa", drag_drop_map: "Clic aquÃ­", map_format: "Col A/B", mode: "Modo", mode_full: "Exacta", mode_partial: "Parcial", btn_start: "Iniciar", btn_processing: "Procesando...", report_title: "Informe", download_tip: "Descargado.", alert_missing: "Faltan archivos", alert_error: "Error: " },
            'pt': { login_title: "Login NecessÃ¡rio", login_btn: "Entrar", login_err: "Senha incorreta", login_ph: "Digite a senha", title: "SubstituiÃ§Ã£o Excel", subtitle: "...", target_files: "Arquivos", drag_drop: "Clique aqui", formats: ".xls .xlsx", replacement_map: "Mapa", drag_drop_map: "Clique aqui", map_format: "Col A/B", mode: "Modo", mode_full: "Exata", mode_partial: "Parcial", btn_start: "Iniciar", btn_processing: "Processando...", report_title: "RelatÃ³rio", download_tip: "Baixado.", alert_missing: "Arquivos ausentes", alert_error: "Erro: " },
            'it': { login_title: "Accesso Richiesto", login_btn: "Login", login_err: "Password errata", login_ph: "Inserisci password", title: "Sostituzione Excel", subtitle: "...", target_files: "File", drag_drop: "Clicca qui", formats: ".xls .xlsx", replacement_map: "Mappa", drag_drop_map: "Clicca qui", map_format: "Col A/B", mode: "Modo", mode_full: "Esatta", mode_partial: "Parziale", btn_start: "Inizia", btn_processing: "Elaborazione...", report_title: "Rapporto", download_tip: "Scaricato.", alert_missing: "File mancanti", alert_error: "Errore: " },
            'de': { login_title: "Anmeldung erforderlich", login_btn: "Anmelden", login_err: "Falsches Passwort", login_ph: "Passwort eingeben", title: "Excel Ersetzen", subtitle: "...", target_files: "Dateien", drag_drop: "Hier klicken", formats: ".xls .xlsx", replacement_map: "Karte", drag_drop_map: "Hier klicken", map_format: "Col A/B", mode: "Modus", mode_full: "Exakt", mode_partial: "Teilweise", btn_start: "Starten", btn_processing: "Verarbeitung...", report_title: "Bericht", download_tip: "Heruntergeladen.", alert_missing: "Dateien fehlen", alert_error: "Fehler: " },
            'ru': { login_title: "Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ²Ñ…Ğ¾Ğ´", login_btn: "Ğ’Ğ¾Ğ¹Ñ‚Ğ¸", login_err: "ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ", login_ph: "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ", title: "Ğ—Ğ°Ğ¼ĞµĞ½Ğ° Excel", subtitle: "...", target_files: "Ğ¤Ğ°Ğ¹Ğ»Ñ‹", drag_drop: "ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ·Ğ´ĞµÑÑŒ", formats: ".xls .xlsx", replacement_map: "ĞšĞ°Ñ€Ñ‚Ğ°", drag_drop_map: "ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ·Ğ´ĞµÑÑŒ", map_format: "Col A/B", mode: "Ğ ĞµĞ¶Ğ¸Ğ¼", mode_full: "Ğ¢Ğ¾Ñ‡Ğ½Ğ¾Ğµ", mode_partial: "Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾Ğµ", btn_start: "ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ", btn_processing: "ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°...", report_title: "ĞÑ‚Ñ‡ĞµÑ‚", download_tip: "Ğ¡ĞºĞ°Ñ‡Ğ°Ğ½Ğ¾.", alert_missing: "ĞĞµÑ‚ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²", alert_error: "ĞÑˆĞ¸Ğ±ĞºĞ°: " },
            'ja': { login_title: "ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™", login_btn: "ãƒ­ã‚°ã‚¤ãƒ³", login_err: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™", login_ph: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›", title: "Excelç½®æ›", subtitle: "...", target_files: "ãƒ•ã‚¡ã‚¤ãƒ«", drag_drop: "ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯", formats: ".xls .xlsx", replacement_map: "å¯¾å¿œè¡¨", drag_drop_map: "ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯", map_format: "Aåˆ—/Båˆ—", mode: "ãƒ¢ãƒ¼ãƒ‰", mode_full: "å®Œå…¨", mode_partial: "éƒ¨åˆ†", btn_start: "é–‹å§‹", btn_processing: "å‡¦ç†ä¸­...", report_title: "ãƒ¬ãƒãƒ¼ãƒˆ", download_tip: "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ã€‚", alert_missing: "ãƒ•ã‚¡ã‚¤ãƒ«ä¸è¶³", alert_error: "ã‚¨ãƒ©ãƒ¼: " }
        };

        // ... (ä¸Šä¼ æ–‡ä»¶é€»è¾‘ setupUpload, handleFiles ç­‰ä¿æŒä¸å˜) ...
        let targetFiles = [];
        let replacementFile = null;
        let currentLang = localStorage.getItem('app_lang') || 'zh-CN';
        let authToken = sessionStorage.getItem('auth_token') || null; // å­˜å‚¨å¯†ç 

        // åˆå§‹åŒ–
        document.getElementById('language-select').value = currentLang;
        updateLanguage(currentLang);
        checkLogin();

        // --- æ–°å¢ï¼šç™»å½•é€»è¾‘ ---
        function checkLogin() {
            const overlay = document.getElementById('login-overlay');
            if (authToken) {
                overlay.classList.add('hidden');
            } else {
                overlay.classList.remove('hidden');
            }
        }

        document.getElementById('login-btn').addEventListener('click', async () => {
            const pwd = document.getElementById('password-input').value;
            const btn = document.getElementById('login-btn');
            const errEl = document.getElementById('login-error');
            
            btn.disabled = true;
            // è°ƒç”¨åç«¯çš„éªŒè¯æ¥å£
            const formData = new FormData();
            formData.append('password', pwd);

            try {
                const res = await fetch('/auth', { method: 'POST', body: formData });
                if (res.ok) {
                    authToken = pwd;
                    sessionStorage.setItem('auth_token', pwd);
                    checkLogin();
                    errEl.style.display = 'none';
                } else {
                    errEl.style.display = 'block';
                    errEl.textContent = translations[currentLang].login_err || 'Error';
                }
            } catch (e) {
                alert('Login Network Error');
            } finally {
                btn.disabled = false;
            }
        });

        document.getElementById('language-select').addEventListener('change', (e) => {
            currentLang = e.target.value;
            localStorage.setItem('app_lang', currentLang);
            updateLanguage(currentLang);
        });

        function updateLanguage(lang) {
            const t = translations[lang] || translations['en'];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });
            const input = document.getElementById('password-input');
            if(input && t['login_ph']) input.placeholder = t['login_ph'];
            
            // ... (åŸæœ¬çš„æŒ‰é’®æ–‡å­—æ›´æ–°é€»è¾‘)
        }

        // ... (setupUpload ç­‰é€»è¾‘ä¿æŒä¸å˜) ...
        const setupUpload = (id, type) => {
            const el = document.getElementById(id);
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xls,.xlsx';
            input.multiple = (type === 'target');
            el.addEventListener('click', () => input.click());
            el.addEventListener('dragover', e => { e.preventDefault(); el.style.background = '#eef7ff'; });
            el.addEventListener('dragleave', e => { e.preventDefault(); el.style.background = 'white'; });
            el.addEventListener('drop', e => { e.preventDefault(); el.style.background = 'white'; handleFiles(e.dataTransfer.files, type); });
            input.onchange = e => handleFiles(e.target.files, type);
        };
        setupUpload('target-upload', 'target');
        setupUpload('replacement-upload', 'replacement');

        function handleFiles(files, type) {
            Array.from(files).forEach(file => {
                if (!file.name.match(/\.xls(x)?$/)) return;
                if (type === 'target') targetFiles.push(file);
                else replacementFile = file;
            });
            renderFiles();
        }

        function renderFiles() {
            const tList = document.getElementById('target-files');
            tList.innerHTML = '';
            targetFiles.forEach((f, i) => {
                tList.innerHTML += `<div class="file-item"><span>${f.name}</span><span class="delete-btn" onclick="del('target', ${i})">Ã—</span></div>`;
            });
            const rList = document.getElementById('replacement-file');
            rList.innerHTML = '';
            if (replacementFile) {
                rList.innerHTML = `<div class="file-item"><span>${replacementFile.name}</span><span class="delete-btn" onclick="del('rep')">Ã—</span></div>`;
            }
        }
        window.del = (type, i) => {
            if (type === 'target') targetFiles.splice(i, 1);
            else replacementFile = null;
            renderFiles();
        };

        // --- ä¿®æ”¹ï¼šStart Process é€»è¾‘ ---
        document.getElementById('start-process').addEventListener('click', async () => {
            // ... (æ ¡éªŒæ–‡ä»¶é€»è¾‘ä¸å˜) ...
            if (targetFiles.length === 0 || !replacementFile) {
                alert(translations[currentLang].alert_missing);
                return;
            }

            const btn = document.getElementById('start-process');
            const spinner = btn.querySelector('.spinner');
            btn.disabled = true;
            spinner.style.display = 'inline-block';
            document.getElementById('report-section').style.display = 'none';

            const formData = new FormData();
            targetFiles.forEach(f => formData.append('targets', f));
            formData.append('replacement', replacementFile);
            formData.append('mode', document.querySelector('input[name="match-mode"]:checked').value);

            try {
                const res = await fetch('/process', { 
                    method: 'POST', 
                    body: formData,
                    // é‡è¦ï¼šæ·»åŠ æˆæƒå¤´
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!res.ok) {
                    if (res.status === 401) {
                        // å¯†ç è¿‡æœŸæˆ–é”™è¯¯ï¼Œé‡æ–°æ˜¾ç¤ºç™»å½•æ¡†
                        authToken = null;
                        sessionStorage.removeItem('auth_token');
                        checkLogin();
                        throw new Error("Authentication failed");
                    }
                    const text = await res.text();
                    console.error('Server Error:', text);
                    throw new Error(`Server Error ${res.status}`);
                }

                // ... (ä¸‹è½½é€»è¾‘ä¸å˜) ...
                const reportHeader = decodeURIComponent(res.headers.get('X-Report-Header') || '');
                document.getElementById('report-content').textContent = reportHeader;
                document.getElementById('report-section').style.display = 'block';

                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `processed_${new Date().getTime()}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

            } catch (e) {
                alert(translations[currentLang].alert_error + e.message);
            } finally {
                btn.disabled = false;
                spinner.style.display = 'none';
            }
        });
    </script>
</body>
</html>
