<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Batch Replacer</title>
    <style>
        /* ... (ä¿ç•™åŸæœ¬çš„ CSS) ... */
        :root { --primary-color: #007bff; --bg-color: #f4f4f9; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: var(--bg-color); }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .lang-selector { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
        .upload-area { border: 2px dashed #ccc; padding: 30px; text-align: center; margin-bottom: 20px; cursor: pointer; background: white; border-radius: 8px; transition: 0.3s; }
        .upload-area:hover { border-color: var(--primary-color); background: #eef7ff; }
        .file-list { margin-top: 10px; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: white; margin-bottom: 5px; border-radius: 4px; border: 1px solid #eee; }
        .delete-btn { color: #dc3545; cursor: pointer; font-weight: bold; }
        button { padding: 15px; background: var(--primary-color); color: white; border: none; font-size: 16px; border-radius: 5px; cursor: pointer; transition: background 0.2s; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 10px; vertical-align: middle; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #report-section { margin-top: 30px; background: white; padding: 20px; border-radius: 8px; display: none; }
        #report-content { max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border: 1px solid #ddd; font-family: monospace; white-space: pre-wrap; margin-bottom: 15px; }

        /* --- æ–°å¢ï¼šç™»å½•çª—å£ CSS --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 300px; text-align: center;
        }
        .login-box h2 { margin-top: 0; color: #333; }
        .login-box input {
            width: 100%; padding: 12px; margin: 20px 0;
            border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px;
        }
        .login-box button { width: 100%; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 data-i18n="login_title">Login Required</h2>
            <input type="password" id="password-input" placeholder="Enter password">
            <button id="login-btn" data-i18n="login_btn">Login</button>
            <p id="login-error" style="color: red; display: none; margin-top: 10px; font-size: 14px;"></p>
        </div>
    </div>

    <div class="header-bar">
        <h1 data-i18n="title">Excel Batch Replacer</h1>
        <select id="language-select" class="lang-selector">
            <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
            <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
            <option value="en">English</option>
            <option value="fr">FranÃ§ais</option>
            <option value="es">EspaÃ±ol</option>
            <option value="pt">PortuguÃªs</option>
            <option value="it">Italiano</option>
            <option value="de">Deutsch</option>
            <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
            <option value="ja">æ—¥æœ¬èª</option>
        </select>
    </div>

    <p data-i18n="subtitle">Efficiently batch replace text in multiple Excel files.</p>
    <section>
        <h2 data-i18n="target_files">Target Excel Files</h2>
        <div id="target-upload" class="upload-area">
            <span class="icon-large">ğŸ“</span>
            <p data-i18n="drag_drop">Click or drag & drop files here</p>
            <p data-i18n="formats">Supports .xls and .xlsx</p>
        </div>
        <div id="target-files" class="file-list"></div>
    </section>

    <section>
        <h2 data-i18n="replacement_map">Replacement Map</h2>
        <div id="replacement-upload" class="upload-area">
            <span class="icon-large">ğŸ“‹</span>
            <p data-i18n="drag_drop_map">Click or drag & drop the map file</p>
            <p data-i18n="map_format">Format: Col A (key), Col B (value)</p>
        </div>
        <div id="replacement-file" class="file-list"></div>
    </section>

    <section>
        <h2 data-i18n="mode">Match Mode</h2>
        <label>
            <input type="radio" name="match-mode" value="full" checked>
            <span data-i18n="mode_full">Full Match</span>
        </label>
        <br><br>
        <label>
            <input type="radio" name="match-mode" value="partial">
            <span data-i18n="mode_partial">Partial Match</span>
        </label>
    </section>
    
    <br>

    <button id="start-process">
        <span class="spinner"></span>
        <span data-i18n="btn_start">Start Processing</span>
    </button>

    <section id="report-section">
        <h2 data-i18n="report_title">Processing Report</h2>
        <div id="report-content"></div>
        <p data-i18n="download_tip">Processed files downloaded.</p>
    </section>

    <script>
        // --- æ›´æ–°ï¼ši18n å­—å…¸ï¼Œå¢åŠ ç™»å½•ç›¸å…³è¯æ¡ ---
       // --- ä¿®æ­£åçš„å®Œæ•´ i18n å­—å…¸ ---
        const translations = {
            'zh-CN': {
                title: "Excelæ‰¹é‡å­—ç¬¦æ›¿æ¢å·¥å…·", subtitle: "é«˜æ•ˆæ‰¹é‡å¤„ç†Excelæ–‡æ¡£ä¸­çš„å­—ç¬¦æ›¿æ¢ä»»åŠ¡",
                target_files: "ç›®æ ‡Excelæ–‡æ¡£", drag_drop: "ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ–‡ä»¶", formats: "æ”¯æŒ .xls å’Œ .xlsx",
                replacement_map: "æ›¿æ¢å¯¹ç…§è¡¨", drag_drop_map: "ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å¯¹ç…§è¡¨æ–‡ä»¶", map_format: "æ ¼å¼ï¼šAåˆ— (key)ï¼ŒBåˆ— (value)",
                mode: "åŒ¹é…æ¨¡å¼", mode_full: "å®Œå…¨åŒ¹é… - å•å…ƒæ ¼å†…å®¹å®Œå…¨ç›¸ç­‰", mode_partial: "éƒ¨åˆ†åŒ¹é… - åŒ…å«å…³é”®å­—å³æ›¿æ¢",
                btn_start: "å¼€å§‹æ›¿æ¢", btn_processing: "å¤„ç†ä¸­...",
                report_title: "å¤„ç†æŠ¥å‘Š", download_tip: "å¤„ç†åçš„æ–‡ä»¶å’Œå®Œæ•´æŠ¥å‘Šå·²æ‰“åŒ…ä¸‹è½½ã€‚",
                alert_missing: "è¯·ä¸Šä¼ ç›®æ ‡æ–‡ä»¶å’Œå¯¹ç…§è¡¨", alert_error: "å¤„ç†å¤±è´¥: ",
                login_title: "éœ€è¦è®¿é—®å¯†ç ", login_btn: "ç™»å½•", login_err: "å¯†ç é”™è¯¯", login_ph: "è¯·è¾“å…¥å¯†ç "
            },
            'zh-TW': {
                title: "Excelæ‰¹é‡å­—ç¬¦æ›¿æ›å·¥å…·", subtitle: "é«˜æ•ˆæ‰¹é‡è™•ç†Excelæ–‡æª”ä¸­çš„å­—ç¬¦æ›¿æ›ä»»å‹™",
                target_files: "ç›®æ¨™Excelæ–‡æª”", drag_drop: "é»æ“Šæˆ–æ‹–æ‹½ä¸Šå‚³æ–‡ä»¶", formats: "æ”¯æŒ .xls å’Œ .xlsx",
                replacement_map: "æ›¿æ›å°ç…§è¡¨", drag_drop_map: "é»æ“Šæˆ–æ‹–æ‹½ä¸Šå‚³å°ç…§è¡¨æ–‡ä»¶", map_format: "æ ¼å¼ï¼šAåˆ— (key)ï¼ŒBåˆ— (value)",
                mode: "åŒ¹é…æ¨¡å¼", mode_full: "å®Œå…¨åŒ¹é… - å–®å…ƒæ ¼å…§å®¹å®Œå…¨ç›¸ç­‰", mode_partial: "éƒ¨åˆ†åŒ¹é… - åŒ…å«é—œéµå­—å³æ›¿æ›",
                btn_start: "é–‹å§‹æ›¿æ›", btn_processing: "è™•ç†ä¸­...",
                report_title: "è™•ç†å ±å‘Š", download_tip: "è™•ç†å¾Œçš„æ–‡ä»¶å’Œå®Œæ•´å ±å‘Šå·²æ‰“åŒ…ä¸‹è¼‰ã€‚",
                alert_missing: "è«‹ä¸Šå‚³ç›®æ¨™æ–‡ä»¶å’Œå°ç…§è¡¨", alert_error: "è™•ç†å¤±æ•—: ",
                login_title: "éœ€è¦è¨ªå•å¯†ç¢¼", login_btn: "ç™»éŒ„", login_err: "å¯†ç¢¼éŒ¯èª¤", login_ph: "è«‹è¼¸å…¥å¯†ç¢¼"
            },
            'en': {
                title: "Excel Batch Replacer", subtitle: "Efficiently batch replace text in multiple Excel files.",
                target_files: "Target Excel Files", drag_drop: "Click or drag & drop files here", formats: "Supports .xls and .xlsx",
                replacement_map: "Replacement Map", drag_drop_map: "Click or drag & drop the map file", map_format: "Format: Col A (key), Col B (value)",
                mode: "Match Mode", mode_full: "Full Match (Exact Cell Content)", mode_partial: "Partial Match (Contains Keyword)",
                btn_start: "Start Processing", btn_processing: "Processing...",
                report_title: "Processing Report", download_tip: "The processed files and full report have been downloaded as a ZIP file.",
                alert_missing: "Please upload target files and replacement map", alert_error: "Error: ",
                login_title: "Login Required", login_btn: "Login", login_err: "Incorrect password", login_ph: "Enter password"
            },
            'fr': {
                title: "Remplacement Excel par Lots", subtitle: "Remplacez efficacement du texte dans plusieurs fichiers Excel.",
                target_files: "Fichiers Excel Cibles", drag_drop: "Cliquez ou glissez-dÃ©posez ici", formats: "Supporte .xls et .xlsx",
                replacement_map: "Table de Correspondance", drag_drop_map: "Cliquez ou glissez-dÃ©posez le fichier", map_format: "Format : Col A (key), Col B (value)",
                mode: "Mode de Correspondance", mode_full: "Correspondance Exacte", mode_partial: "Correspondance Partielle",
                btn_start: "Commencer", btn_processing: "Traitement...",
                report_title: "Rapport", download_tip: "Les fichiers traitÃ©s ont Ã©tÃ© tÃ©lÃ©chargÃ©s sous forme d'archive ZIP.",
                alert_missing: "Veuillez tÃ©lÃ©charger les fichiers cibles et la carte", alert_error: "Erreur : ",
                login_title: "Connexion requise", login_btn: "Connexion", login_err: "Mot de passe incorrect", login_ph: "Entrer le mot de passe"
            },
            'es': {
                title: "Reemplazo por Lotes de Excel", subtitle: "Reemplace texto en mÃºltiples archivos Excel eficientemente.",
                target_files: "Archivos Excel Objetivo", drag_drop: "Haga clic o arrastre archivos aquÃ­", formats: "Soporta .xls y .xlsx",
                replacement_map: "Mapa de Reemplazo", drag_drop_map: "Haga clic o arrastre el archivo de mapa", map_format: "Formato: Col A (key), Col B (value)",
                mode: "Modo de Coincidencia", mode_full: "Coincidencia Exacta", mode_partial: "Coincidencia Parcial",
                btn_start: "Iniciar Proceso", btn_processing: "Procesando...",
                report_title: "Informe", download_tip: "Los archivos procesados se han descargado como un archivo ZIP.",
                alert_missing: "Cargue los archivos de destino y el mapa", alert_error: "Error: ",
                login_title: "Inicio de sesiÃ³n", login_btn: "Entrar", login_err: "ContraseÃ±a incorrecta", login_ph: "ContraseÃ±a"
            },
            'pt': {
                title: "SubstituiÃ§Ã£o em Lote Excel", subtitle: "Substitua texto em vÃ¡rios arquivos Excel com eficiÃªncia.",
                target_files: "Arquivos Excel Alvo", drag_drop: "Clique ou arraste arquivos aqui", formats: "Suporta .xls e .xlsx",
                replacement_map: "Mapa de SubstituiÃ§Ã£o", drag_drop_map: "Clique ou arraste o arquivo de mapa", map_format: "Formato: Col A (key), Col B (value)",
                mode: "Modo de CorrespondÃªncia", mode_full: "CorrespondÃªncia Exata", mode_partial: "CorrespondÃªncia Parcial",
                btn_start: "Iniciar Processo", btn_processing: "Processando...",
                report_title: "RelatÃ³rio", download_tip: "Os arquivos processados foram baixados como um arquivo ZIP.",
                alert_missing: "FaÃ§a upload dos arquivos de destino e do mapa", alert_error: "Erro: ",
                login_title: "Login NecessÃ¡rio", login_btn: "Entrar", login_err: "Senha incorreta", login_ph: "Digite a senha"
            },
            'it': {
                title: "Sostituzione Batch Excel", subtitle: "Sostituisci testo in piÃ¹ file Excel in modo efficiente.",
                target_files: "File Excel di Destinazione", drag_drop: "Clicca o trascina i file qui", formats: "Supporta .xls e .xlsx",
                replacement_map: "Mappa di Sostituzione", drag_drop_map: "Clicca o trascina il file mappa", map_format: "Formato: Col A (key), Col B (value)",
                mode: "ModalitÃ  Corrispondenza", mode_full: "Corrispondenza Esatta", mode_partial: "Corrispondenza Parziale",
                btn_start: "Inizia Processo", btn_processing: "Elaborazione...",
                report_title: "Rapporto", download_tip: "I file elaborati sono stati scaricati come file ZIP.",
                alert_missing: "Carica i file di destinazione e la mappa", alert_error: "Errore: ",
                login_title: "Accesso Richiesto", login_btn: "Login", login_err: "Password errata", login_ph: "Inserisci password"
            },
            'de': {
                title: "Excel Batch Ersetzen", subtitle: "Ersetzen Sie Text in mehreren Excel-Dateien effizient.",
                target_files: "Ziel-Excel-Dateien", drag_drop: "Klicken oder Dateien hierher ziehen", formats: "UnterstÃ¼tzt .xls und .xlsx",
                replacement_map: "Ersetzungstabelle", drag_drop_map: "Klicken oder Tabellendatei hierher ziehen", map_format: "Format: Spalte A (key), Spalte B (value)",
                mode: "Ãœbereinstimmungsmodus", mode_full: "Genaue Ãœbereinstimmung", mode_partial: "Teilweise Ãœbereinstimmung",
                btn_start: "Starten", btn_processing: "Verarbeitung...",
                report_title: "Bericht", download_tip: "Die verarbeiteten Dateien wurden als ZIP heruntergeladen.",
                alert_missing: "Bitte laden Sie Zieldateien und Karte hoch", alert_error: "Fehler: ",
                login_title: "Anmeldung erforderlich", login_btn: "Anmelden", login_err: "Falsches Passwort", login_ph: "Passwort eingeben"
            },
            'ru': {
                title: "ĞŸĞ°ĞºĞµÑ‚Ğ½Ğ°Ñ Ğ·Ğ°Ğ¼ĞµĞ½Ğ° Ğ² Excel", subtitle: "Ğ­Ñ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ Ğ·Ğ°Ğ¼ĞµĞ½Ğ° Ñ‚ĞµĞºÑÑ‚Ğ° Ğ² Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ°Ñ… Excel.",
                target_files: "Ğ¦ĞµĞ»ĞµĞ²Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Excel", drag_drop: "ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ¸Ğ»Ğ¸ Ğ¿ĞµÑ€ĞµÑ‚Ğ°Ñ‰Ğ¸Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ ÑÑĞ´Ğ°", formats: "ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ .xls Ğ¸ .xlsx",
                replacement_map: "Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ·Ğ°Ğ¼ĞµĞ½", drag_drop_map: "ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ¸Ğ»Ğ¸ Ğ¿ĞµÑ€ĞµÑ‚Ğ°Ñ‰Ğ¸Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ» Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹", map_format: "Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: Ğ¡Ñ‚Ğ¾Ğ»Ğ±ĞµÑ† A (key), Ğ¡Ñ‚Ğ¾Ğ»Ğ±ĞµÑ† B (value)",
                mode: "Ğ ĞµĞ¶Ğ¸Ğ¼ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ", mode_full: "ĞŸĞ¾Ğ»Ğ½Ğ¾Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ", mode_partial: "Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ",
                btn_start: "ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ", btn_processing: "ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°...",
                report_title: "ĞÑ‚Ñ‡ĞµÑ‚", download_tip: "ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ±Ñ‹Ğ»Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹ ĞºĞ°Ğº ZIP-Ğ°Ñ€Ñ…Ğ¸Ğ².",
                alert_missing: "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚Ğµ Ñ†ĞµĞ»ĞµĞ²Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¸ ĞºĞ°Ñ€Ñ‚Ñƒ", alert_error: "ĞÑˆĞ¸Ğ±ĞºĞ°: ",
                login_title: "Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ²Ñ…Ğ¾Ğ´", login_btn: "Ğ’Ğ¾Ğ¹Ñ‚Ğ¸", login_err: "ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ", login_ph: "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ"
            },
            'ja': {
                title: "Excelä¸€æ‹¬ç½®æ›ãƒ„ãƒ¼ãƒ«", subtitle: "è¤‡æ•°ã®Excelãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’åŠ¹ç‡çš„ã«ä¸€æ‹¬ç½®æ›ã—ã¾ã™ã€‚",
                target_files: "å¯¾è±¡Excelãƒ•ã‚¡ã‚¤ãƒ«", drag_drop: "ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—", formats: ".xls ãŠã‚ˆã³ .xlsx ã‚’ã‚µãƒãƒ¼ãƒˆ",
                replacement_map: "ç½®æ›å¯¾å¿œè¡¨", drag_drop_map: "ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹å¯¾å¿œè¡¨ã‚’ãƒ‰ãƒ­ãƒƒãƒ—", map_format: "å½¢å¼: Aåˆ— (key), Båˆ— (value)",
                mode: "ä¸€è‡´ãƒ¢ãƒ¼ãƒ‰", mode_full: "å®Œå…¨ä¸€è‡´ï¼ˆã‚»ãƒ«å†…å®¹ãŒå®Œå…¨ã«ä¸€è‡´ï¼‰", mode_partial: "éƒ¨åˆ†ä¸€è‡´ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€ï¼‰",
                btn_start: "å‡¦ç†é–‹å§‹", btn_processing: "å‡¦ç†ä¸­...",
                report_title: "å‡¦ç†ãƒ¬ãƒãƒ¼ãƒˆ", download_tip: "å‡¦ç†æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ¬ãƒãƒ¼ãƒˆãŒZIPå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚",
                alert_missing: "å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã¨å¯¾å¿œè¡¨ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„", alert_error: "ã‚¨ãƒ©ãƒ¼: ",
                login_title: "ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™", login_btn: "ãƒ­ã‚°ã‚¤ãƒ³", login_err: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™", login_ph: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
            }
        };

        // ... (ä¸Šä¼ æ–‡ä»¶é€»è¾‘ setupUpload, handleFiles ç­‰ä¿æŒä¸å˜) ...
        let targetFiles = [];
        let replacementFile = null;
        let currentLang = localStorage.getItem('app_lang') || 'zh-CN';
        let authToken = sessionStorage.getItem('auth_token') || null; // å­˜å‚¨å¯†ç 

        // åˆå§‹åŒ–
        document.getElementById('language-select').value = currentLang;
        updateLanguage(currentLang);
        checkLogin();

        // --- æ–°å¢ï¼šç™»å½•é€»è¾‘ ---
        function checkLogin() {
            const overlay = document.getElementById('login-overlay');
            if (authToken) {
                overlay.classList.add('hidden');
            } else {
                overlay.classList.remove('hidden');
            }
        }

        document.getElementById('login-btn').addEventListener('click', async () => {
            const pwd = document.getElementById('password-input').value;
            const btn = document.getElementById('login-btn');
            const errEl = document.getElementById('login-error');
            
            btn.disabled = true;
            // è°ƒç”¨åç«¯çš„éªŒè¯æ¥å£
            const formData = new FormData();
            formData.append('password', pwd);

            try {
                const res = await fetch('/auth', { method: 'POST', body: formData });
                if (res.ok) {
                    authToken = pwd;
                    sessionStorage.setItem('auth_token', pwd);
                    checkLogin();
                    errEl.style.display = 'none';
                } else {
                    errEl.style.display = 'block';
                    errEl.textContent = translations[currentLang].login_err || 'Error';
                }
            } catch (e) {
                alert('Login Network Error');
            } finally {
                btn.disabled = false;
            }
        });

        document.getElementById('language-select').addEventListener('change', (e) => {
            currentLang = e.target.value;
            localStorage.setItem('app_lang', currentLang);
            updateLanguage(currentLang);
        });

        function updateLanguage(lang) {
            const t = translations[lang] || translations['en'];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });
            const input = document.getElementById('password-input');
            if(input && t['login_ph']) input.placeholder = t['login_ph'];
            
            // ... (åŸæœ¬çš„æŒ‰é’®æ–‡å­—æ›´æ–°é€»è¾‘)
        }

        // ... (setupUpload ç­‰é€»è¾‘ä¿æŒä¸å˜) ...
        const setupUpload = (id, type) => {
            const el = document.getElementById(id);
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xls,.xlsx';
            input.multiple = (type === 'target');
            el.addEventListener('click', () => input.click());
            el.addEventListener('dragover', e => { e.preventDefault(); el.style.background = '#eef7ff'; });
            el.addEventListener('dragleave', e => { e.preventDefault(); el.style.background = 'white'; });
            el.addEventListener('drop', e => { e.preventDefault(); el.style.background = 'white'; handleFiles(e.dataTransfer.files, type); });
            input.onchange = e => handleFiles(e.target.files, type);
        };
        setupUpload('target-upload', 'target');
        setupUpload('replacement-upload', 'replacement');

        function handleFiles(files, type) {
            Array.from(files).forEach(file => {
                if (!file.name.match(/\.xls(x)?$/)) return;
                if (type === 'target') targetFiles.push(file);
                else replacementFile = file;
            });
            renderFiles();
        }

        function renderFiles() {
            const tList = document.getElementById('target-files');
            tList.innerHTML = '';
            targetFiles.forEach((f, i) => {
                tList.innerHTML += `<div class="file-item"><span>${f.name}</span><span class="delete-btn" onclick="del('target', ${i})">Ã—</span></div>`;
            });
            const rList = document.getElementById('replacement-file');
            rList.innerHTML = '';
            if (replacementFile) {
                rList.innerHTML = `<div class="file-item"><span>${replacementFile.name}</span><span class="delete-btn" onclick="del('rep')">Ã—</span></div>`;
            }
        }
        window.del = (type, i) => {
            if (type === 'target') targetFiles.splice(i, 1);
            else replacementFile = null;
            renderFiles();
        };

        // --- ä¿®æ”¹ï¼šStart Process é€»è¾‘ ---
        document.getElementById('start-process').addEventListener('click', async () => {
            // ... (æ ¡éªŒæ–‡ä»¶é€»è¾‘ä¸å˜) ...
            if (targetFiles.length === 0 || !replacementFile) {
                alert(translations[currentLang].alert_missing);
                return;
            }

            const btn = document.getElementById('start-process');
            const spinner = btn.querySelector('.spinner');
            btn.disabled = true;
            spinner.style.display = 'inline-block';
            document.getElementById('report-section').style.display = 'none';

            const formData = new FormData();
            targetFiles.forEach(f => formData.append('targets', f));
            formData.append('replacement', replacementFile);
            formData.append('mode', document.querySelector('input[name="match-mode"]:checked').value);

            try {
                const res = await fetch('/process', { 
                    method: 'POST', 
                    body: formData,
                    // é‡è¦ï¼šæ·»åŠ æˆæƒå¤´
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!res.ok) {
                    if (res.status === 401) {
                        // å¯†ç è¿‡æœŸæˆ–é”™è¯¯ï¼Œé‡æ–°æ˜¾ç¤ºç™»å½•æ¡†
                        authToken = null;
                        sessionStorage.removeItem('auth_token');
                        checkLogin();
                        throw new Error("Authentication failed");
                    }
                    const text = await res.text();
                    console.error('Server Error:', text);
                    throw new Error(`Server Error ${res.status}`);
                }

                // ... (ä¸‹è½½é€»è¾‘ä¸å˜) ...
                const reportHeader = decodeURIComponent(res.headers.get('X-Report-Header') || '');
                document.getElementById('report-content').textContent = reportHeader;
                document.getElementById('report-section').style.display = 'block';

                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `processed_${new Date().getTime()}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

            } catch (e) {
                alert(translations[currentLang].alert_error + e.message);
            } finally {
                btn.disabled = false;
                spinner.style.display = 'none';
            }
        });
    </script>
</body>
</html>
