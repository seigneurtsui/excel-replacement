<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Batch Replacer</title>
    <style>
        :root { --primary-color: #007bff; --bg-color: #f4f4f9; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: var(--bg-color); }
        
        /* È°∂ÈÉ®Ê†è */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .lang-selector { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }

        .upload-area { border: 2px dashed #ccc; padding: 30px; text-align: center; margin-bottom: 20px; cursor: pointer; background: white; border-radius: 8px; transition: 0.3s; }
        .upload-area:hover { border-color: var(--primary-color); background: #eef7ff; }
        .upload-area p { margin: 5px 0; color: #666; }
        .icon-large { font-size: 40px; margin-bottom: 10px; display: block; }
        
        .file-list { margin-top: 10px; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: white; margin-bottom: 5px; border-radius: 4px; border: 1px solid #eee; }
        .delete-btn { color: #dc3545; cursor: pointer; font-weight: bold; }
        
        button#start-process { width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; font-size: 16px; border-radius: 5px; cursor: pointer; transition: background 0.2s; }
        button#start-process:hover { background: #0056b3; }
        button#start-process:disabled { background: #ccc; cursor: not-allowed; }

        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 10px; vertical-align: middle; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #report-section { margin-top: 30px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: none; }
        #report-content { max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border: 1px solid #ddd; font-family: monospace; white-space: pre-wrap; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div class="header-bar">
        <h1 data-i18n="title">Excel Batch Replacer</h1>
        <select id="language-select" class="lang-selector">
            <option value="zh-CN">ÁÆÄ‰Ωì‰∏≠Êñá</option>
            <option value="zh-TW">ÁπÅÈ´î‰∏≠Êñá</option>
            <option value="en">English</option>
            <option value="fr">Fran√ßais</option>
            <option value="es">Espa√±ol</option>
            <option value="pt">Portugu√™s</option>
            <option value="it">Italiano</option>
            <option value="de">Deutsch</option>
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="ja">Êó•Êú¨Ë™û</option>
        </select>
    </div>

    <p data-i18n="subtitle">Efficiently batch replace text in multiple Excel files.</p>

    <section>
        <h2 data-i18n="target_files">Target Excel Files</h2>
        <div id="target-upload" class="upload-area">
            <span class="icon-large">üìÅ</span>
            <p data-i18n="drag_drop">Click or drag & drop files here</p>
            <p data-i18n="formats">Supports .xls and .xlsx</p>
        </div>
        <div id="target-files" class="file-list"></div>
    </section>

    <section>
        <h2 data-i18n="replacement_map">Replacement Map</h2>
        <div id="replacement-upload" class="upload-area">
            <span class="icon-large">üìã</span>
            <p data-i18n="drag_drop_map">Click or drag & drop the map file</p>
            <p data-i18n="map_format">Format: Col A (Find), Col B (Replace)</p>
        </div>
        <div id="replacement-file" class="file-list"></div>
    </section>

    <section>
        <h2 data-i18n="mode">Match Mode</h2>
        <label>
            <input type="radio" name="match-mode" value="full" checked>
            <span data-i18n="mode_full">Full Match (Exact Cell Content)</span>
        </label>
        <br><br>
        <label>
            <input type="radio" name="match-mode" value="partial">
            <span data-i18n="mode_partial">Partial Match (Contains Keyword)</span>
        </label>
    </section>
    
    <br>

    <button id="start-process">
        <span class="spinner"></span>
        <span data-i18n="btn_start">Start Processing</span>
    </button>

    <section id="report-section">
        <h2 data-i18n="report_title">Processing Report</h2>
        <div id="report-content"></div>
        <p data-i18n="download_tip">The processed files and full report have been downloaded as a ZIP file.</p>
    </section>

    <script>
        // --- i18n Dictionary ---
        const translations = {
            'zh-CN': {
                title: "ExcelÊâπÈáèÂ≠óÁ¨¶ÊõøÊç¢Â∑•ÂÖ∑", subtitle: "È´òÊïàÊâπÈáèÂ§ÑÁêÜExcelÊñáÊ°£‰∏≠ÁöÑÂ≠óÁ¨¶ÊõøÊç¢‰ªªÂä°",
                target_files: "ÁõÆÊ†áExcelÊñáÊ°£", drag_drop: "ÁÇπÂáªÊàñÊãñÊãΩ‰∏ä‰º†Êñá‰ª∂", formats: "ÊîØÊåÅ .xls Âíå .xlsx",
                replacement_map: "ÊõøÊç¢ÂØπÁÖßË°®", drag_drop_map: "ÁÇπÂáªÊàñÊãñÊãΩ‰∏ä‰º†ÂØπÁÖßË°®Êñá‰ª∂", map_format: "Ê†ºÂºèÔºöAÂàó(Êü•Êâæ)ÔºåBÂàó(ÊõøÊç¢)",
                mode: "ÂåπÈÖçÊ®°Âºè", mode_full: "ÂÆåÂÖ®ÂåπÈÖç - ÂçïÂÖÉÊ†ºÂÜÖÂÆπÂÆåÂÖ®Áõ∏Á≠â", mode_partial: "ÈÉ®ÂàÜÂåπÈÖç - ÂåÖÂê´ÂÖ≥ÈîÆÂ≠óÂç≥ÊõøÊç¢",
                btn_start: "ÂºÄÂßãÊõøÊç¢", btn_processing: "Â§ÑÁêÜ‰∏≠...",
                report_title: "Â§ÑÁêÜÊä•Âëä", download_tip: "Â§ÑÁêÜÂêéÁöÑÊñá‰ª∂ÂíåÂÆåÊï¥Êä•ÂëäÂ∑≤ÊâìÂåÖ‰∏ãËΩΩ„ÄÇ",
                alert_missing: "ËØ∑‰∏ä‰º†ÁõÆÊ†áÊñá‰ª∂ÂíåÂØπÁÖßË°®", alert_error: "Â§ÑÁêÜÂ§±Ë¥•: "
            },
            'zh-TW': {
                title: "ExcelÊâπÈáèÂ≠óÁ¨¶ÊõøÊèõÂ∑•ÂÖ∑", subtitle: "È´òÊïàÊâπÈáèËôïÁêÜExcelÊñáÊ™î‰∏≠ÁöÑÂ≠óÁ¨¶ÊõøÊèõ‰ªªÂãô",
                target_files: "ÁõÆÊ®ôExcelÊñáÊ™î", drag_drop: "ÈªûÊìäÊàñÊãñÊãΩ‰∏äÂÇ≥Êñá‰ª∂", formats: "ÊîØÊåÅ .xls Âíå .xlsx",
                replacement_map: "ÊõøÊèõÂ∞çÁÖßË°®", drag_drop_map: "ÈªûÊìäÊàñÊãñÊãΩ‰∏äÂÇ≥Â∞çÁÖßË°®Êñá‰ª∂", map_format: "Ê†ºÂºèÔºöAÂàó(Êü•Êâæ)ÔºåBÂàó(ÊõøÊèõ)",
                mode: "ÂåπÈÖçÊ®°Âºè", mode_full: "ÂÆåÂÖ®ÂåπÈÖç - ÂñÆÂÖÉÊ†ºÂÖßÂÆπÂÆåÂÖ®Áõ∏Á≠â", mode_partial: "ÈÉ®ÂàÜÂåπÈÖç - ÂåÖÂê´ÈóúÈçµÂ≠óÂç≥ÊõøÊèõ",
                btn_start: "ÈñãÂßãÊõøÊèõ", btn_processing: "ËôïÁêÜ‰∏≠...",
                report_title: "ËôïÁêÜÂ†±Âëä", download_tip: "ËôïÁêÜÂæåÁöÑÊñá‰ª∂ÂíåÂÆåÊï¥Â†±ÂëäÂ∑≤ÊâìÂåÖ‰∏ãËºâ„ÄÇ",
                alert_missing: "Ë´ã‰∏äÂÇ≥ÁõÆÊ®ôÊñá‰ª∂ÂíåÂ∞çÁÖßË°®", alert_error: "ËôïÁêÜÂ§±Êïó: "
            },
            'en': {
                title: "Excel Batch Replacer", subtitle: "Efficiently batch replace text in multiple Excel files.",
                target_files: "Target Excel Files", drag_drop: "Click or drag & drop files here", formats: "Supports .xls and .xlsx",
                replacement_map: "Replacement Map", drag_drop_map: "Click or drag & drop the map file", map_format: "Format: Col A (Find), Col B (Replace)",
                mode: "Match Mode", mode_full: "Full Match (Exact Cell Content)", mode_partial: "Partial Match (Contains Keyword)",
                btn_start: "Start Processing", btn_processing: "Processing...",
                report_title: "Processing Report", download_tip: "The processed files and full report have been downloaded as a ZIP file.",
                alert_missing: "Please upload target files and replacement map", alert_error: "Error: "
            },
            'fr': {
                title: "Remplacement Excel par Lots", subtitle: "Remplacez efficacement du texte dans plusieurs fichiers Excel.",
                target_files: "Fichiers Excel Cibles", drag_drop: "Cliquez ou glissez-d√©posez ici", formats: "Supporte .xls et .xlsx",
                replacement_map: "Table de Correspondance", drag_drop_map: "Cliquez ou glissez-d√©posez le fichier", map_format: "Format: Col A (Recherche), Col B (Remplacement)",
                mode: "Mode de Correspondance", mode_full: "Correspondance Exacte", mode_partial: "Correspondance Partielle",
                btn_start: "Commencer", btn_processing: "Traitement...",
                report_title: "Rapport", download_tip: "Les fichiers trait√©s ont √©t√© t√©l√©charg√©s sous forme d'archive ZIP.",
                alert_missing: "Veuillez t√©l√©charger les fichiers cibles et la carte", alert_error: "Erreur: "
            },
            'es': {
                title: "Reemplazo por Lotes de Excel", subtitle: "Reemplace texto en m√∫ltiples archivos Excel eficientemente.",
                target_files: "Archivos Excel Objetivo", drag_drop: "Haga clic o arrastre archivos aqu√≠", formats: "Soporta .xls y .xlsx",
                replacement_map: "Mapa de Reemplazo", drag_drop_map: "Haga clic o arrastre el archivo de mapa", map_format: "Formato: Col A (Buscar), Col B (Reemplazar)",
                mode: "Modo de Coincidencia", mode_full: "Coincidencia Exacta", mode_partial: "Coincidencia Parcial",
                btn_start: "Iniciar Proceso", btn_processing: "Procesando...",
                report_title: "Informe", download_tip: "Los archivos procesados se han descargado como un archivo ZIP.",
                alert_missing: "Cargue los archivos de destino y el mapa", alert_error: "Error: "
            },
            'pt': {
                title: "Substitui√ß√£o em Lote Excel", subtitle: "Substitua texto em v√°rios arquivos Excel com efici√™ncia.",
                target_files: "Arquivos Excel Alvo", drag_drop: "Clique ou arraste arquivos aqui", formats: "Suporta .xls e .xlsx",
                replacement_map: "Mapa de Substitui√ß√£o", drag_drop_map: "Clique ou arraste o arquivo de mapa", map_format: "Formato: Col A (Localizar), Col B (Substituir)",
                mode: "Modo de Correspond√™ncia", mode_full: "Correspond√™ncia Exata", mode_partial: "Correspond√™ncia Parcial",
                btn_start: "Iniciar Processo", btn_processing: "Processando...",
                report_title: "Relat√≥rio", download_tip: "Os arquivos processados foram baixados como um arquivo ZIP.",
                alert_missing: "Fa√ßa upload dos arquivos de destino e do mapa", alert_error: "Erro: "
            },
            'it': {
                title: "Sostituzione Batch Excel", subtitle: "Sostituisci testo in pi√π file Excel in modo efficiente.",
                target_files: "File Excel di Destinazione", drag_drop: "Clicca o trascina i file qui", formats: "Supporta .xls e .xlsx",
                replacement_map: "Mappa di Sostituzione", drag_drop_map: "Clicca o trascina il file mappa", map_format: "Formato: Col A (Trova), Col B (Sostituisci)",
                mode: "Modalit√† Corrispondenza", mode_full: "Corrispondenza Esatta", mode_partial: "Corrispondenza Parziale",
                btn_start: "Inizia Processo", btn_processing: "Elaborazione...",
                report_title: "Rapporto", download_tip: "I file elaborati sono stati scaricati come file ZIP.",
                alert_missing: "Carica i file di destinazione e la mappa", alert_error: "Errore: "
            },
            'de': {
                title: "Excel Batch Ersetzen", subtitle: "Ersetzen Sie Text in mehreren Excel-Dateien effizient.",
                target_files: "Ziel-Excel-Dateien", drag_drop: "Klicken oder Dateien hierher ziehen", formats: "Unterst√ºtzt .xls und .xlsx",
                replacement_map: "Ersetzungstabelle", drag_drop_map: "Klicken oder Tabellendatei hierher ziehen", map_format: "Format: Spalte A (Suchen), Spalte B (Ersetzen)",
                mode: "√úbereinstimmungsmodus", mode_full: "Genaue √úbereinstimmung", mode_partial: "Teilweise √úbereinstimmung",
                btn_start: "Starten", btn_processing: "Verarbeitung...",
                report_title: "Bericht", download_tip: "Die verarbeiteten Dateien wurden als ZIP heruntergeladen.",
                alert_missing: "Bitte laden Sie Zieldateien und Karte hoch", alert_error: "Fehler: "
            },
            'ru': {
                title: "–ü–∞–∫–µ—Ç–Ω–∞—è –∑–∞–º–µ–Ω–∞ –≤ Excel", subtitle: "–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –∑–∞–º–µ–Ω–∞ —Ç–µ–∫—Å—Ç–∞ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–∞—Ö Excel.",
                target_files: "–¶–µ–ª–µ–≤—ã–µ —Ñ–∞–π–ª—ã Excel", drag_drop: "–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞", formats: "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç .xls –∏ .xlsx",
                replacement_map: "–¢–∞–±–ª–∏—Ü–∞ –∑–∞–º–µ–Ω", drag_drop_map: "–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Ç–∞–±–ª–∏—Ü—ã", map_format: "–§–æ—Ä–º–∞—Ç: –°—Ç–æ–ª–±–µ—Ü A (–ù–∞–π—Ç–∏), –°—Ç–æ–ª–±–µ—Ü B (–ó–∞–º–µ–Ω–∏—Ç—å)",
                mode: "–†–µ–∂–∏–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è", mode_full: "–ü–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ", mode_partial: "–ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ",
                btn_start: "–ù–∞—á–∞—Ç—å", btn_processing: "–û–±—Ä–∞–±–æ—Ç–∫–∞...",
                report_title: "–û—Ç—á–µ—Ç", download_tip: "–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∫–∞–∫ ZIP-–∞—Ä—Ö–∏–≤.",
                alert_missing: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ü–µ–ª–µ–≤—ã–µ —Ñ–∞–π–ª—ã –∏ –∫–∞—Ä—Ç—É", alert_error: "–û—à–∏–±–∫–∞: "
            },
            'ja': {
                title: "Excel‰∏ÄÊã¨ÁΩÆÊèõ„ÉÑ„Éº„É´", subtitle: "Ë§áÊï∞„ÅÆExcel„Éï„Ç°„Ç§„É´ÂÜÖ„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂäπÁéáÁöÑ„Å´‰∏ÄÊã¨ÁΩÆÊèõ„Åó„Åæ„Åô„ÄÇ",
                target_files: "ÂØæË±°Excel„Éï„Ç°„Ç§„É´", drag_drop: "„Åì„Åì„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Åã„Éï„Ç°„Ç§„É´„Çí„Éâ„É≠„ÉÉ„Éó", formats: ".xls „Åä„Çà„Å≥ .xlsx „Çí„Çµ„Éù„Éº„Éà",
                replacement_map: "ÁΩÆÊèõÂØæÂøúË°®", drag_drop_map: "„Åì„Åì„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„ÅãÂØæÂøúË°®„Çí„Éâ„É≠„ÉÉ„Éó", map_format: "ÂΩ¢Âºè: AÂàó(Ê§úÁ¥¢), BÂàó(ÁΩÆÊèõ)",
                mode: "‰∏ÄËá¥„É¢„Éº„Éâ", mode_full: "ÂÆåÂÖ®‰∏ÄËá¥Ôºà„Çª„É´ÂÜÖÂÆπ„ÅåÂÆåÂÖ®„Å´‰∏ÄËá¥Ôºâ", mode_partial: "ÈÉ®ÂàÜ‰∏ÄËá¥Ôºà„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂê´„ÇÄÔºâ",
                btn_start: "Âá¶ÁêÜÈñãÂßã", btn_processing: "Âá¶ÁêÜ‰∏≠...",
                report_title: "Âá¶ÁêÜ„É¨„Éù„Éº„Éà", download_tip: "Âá¶ÁêÜÊ∏à„Åø„Éï„Ç°„Ç§„É´„Å®„É¨„Éù„Éº„Éà„ÅåZIPÂΩ¢Âºè„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åï„Çå„Åæ„Åó„Åü„ÄÇ",
                alert_missing: "ÂØæË±°„Éï„Ç°„Ç§„É´„Å®ÂØæÂøúË°®„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ", alert_error: "„Ç®„É©„Éº: "
            }
        };

        // --- Logic ---
        let targetFiles = [];
        let replacementFile = null;
        let currentLang = localStorage.getItem('app_lang') || 'zh-CN';

        // Initialize Language
        document.getElementById('language-select').value = currentLang;
        updateLanguage(currentLang);

        document.getElementById('language-select').addEventListener('change', (e) => {
            currentLang = e.target.value;
            localStorage.setItem('app_lang', currentLang);
            updateLanguage(currentLang);
        });

        function updateLanguage(lang) {
            const t = translations[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });
            // Update button text explicitly if not processing
            const btn = document.getElementById('start-process');
            if (!btn.disabled) {
                const span = btn.querySelector('[data-i18n="btn_start"]');
                if(span) span.textContent = t['btn_start'];
            }
        }

        // File Handling
        const setupUpload = (id, type) => {
            const el = document.getElementById(id);
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xls,.xlsx';
            input.multiple = (type === 'target');
            
            el.addEventListener('click', () => input.click());
            el.addEventListener('dragover', e => { e.preventDefault(); el.style.background = '#eef7ff'; });
            el.addEventListener('dragleave', e => { e.preventDefault(); el.style.background = 'white'; });
            el.addEventListener('drop', e => {
                e.preventDefault();
                el.style.background = 'white';
                handleFiles(e.dataTransfer.files, type);
            });
            input.onchange = e => handleFiles(e.target.files, type);
        };

        setupUpload('target-upload', 'target');
        setupUpload('replacement-upload', 'replacement');

        function handleFiles(files, type) {
            Array.from(files).forEach(file => {
                if (!file.name.match(/\.xls(x)?$/)) return;
                if (type === 'target') targetFiles.push(file);
                else replacementFile = file;
            });
            renderFiles();
        }

        function renderFiles() {
            const tList = document.getElementById('target-files');
            tList.innerHTML = '';
            targetFiles.forEach((f, i) => {
                tList.innerHTML += `<div class="file-item"><span>${f.name}</span><span class="delete-btn" onclick="del('target', ${i})">√ó</span></div>`;
            });

            const rList = document.getElementById('replacement-file');
            rList.innerHTML = '';
            if (replacementFile) {
                rList.innerHTML = `<div class="file-item"><span>${replacementFile.name}</span><span class="delete-btn" onclick="del('rep')">√ó</span></div>`;
            }
        }

        window.del = (type, i) => {
            if (type === 'target') targetFiles.splice(i, 1);
            else replacementFile = null;
            renderFiles();
        };

        // Processing
        document.getElementById('start-process').addEventListener('click', async () => {
            const t = translations[currentLang];
            if (targetFiles.length === 0 || !replacementFile) {
                alert(t.alert_missing);
                return;
            }

            const btn = document.getElementById('start-process');
            const spinner = btn.querySelector('.spinner');
            const btnText = btn.querySelector('span[data-i18n]');
            
            btn.disabled = true;
            spinner.style.display = 'inline-block';
            btnText.textContent = t.btn_processing;
            document.getElementById('report-section').style.display = 'none';

            const formData = new FormData();
            targetFiles.forEach(f => formData.append('targets', f));
            formData.append('replacement', replacementFile);
            formData.append('mode', document.querySelector('input[name="match-mode"]:checked').value);

            try {
                const res = await fetch('/process', { method: 'POST', body: formData });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || 'Server Error');
                }

                // Get report header before consuming blob
                const reportHeader = decodeURIComponent(res.headers.get('X-Report-Header') || '');
                document.getElementById('report-content').textContent = reportHeader;
                document.getElementById('report-section').style.display = 'block';

                // Download ZIP
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `processed_${new Date().getTime()}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

            } catch (e) {
                alert(t.alert_error + e.message);
            } finally {
                btn.disabled = false;
                spinner.style.display = 'none';
                btnText.textContent = t.btn_start; // Revert to "Start" in correct lang via data-i18n if needed, but simple reset works
                updateLanguage(currentLang); // Ensure text is correct
            }
        });
    </script>
</body>
</html>
